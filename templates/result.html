<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Результаты проверки эссе</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 900px; 
      margin: 0 auto; 
      padding: 30px; 
      background-color: #f5f5f5; 
      color: #2c3e50;
    }
    .container { 
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    h1 { 
      text-align: center; 
      margin-bottom: 40px; 
      font-size: 24px; 
      color: #2c3e50;
    }
    h2 { 
      margin-top: 30px; 
      font-size: 20px; 
      border-bottom: 2px solid #ddd; 
      padding-bottom: 8px;
    }
    .essay-block {
      background-color: #fdfdfd;
      border-left: 4px solid #34495e;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 35px;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      border: 1px solid #dcdcdc;
    }
    .results-table th, .results-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: top;
    }
    .results-table th {
      width: 25%;
      background-color: #f7f9fb;
      text-align: left;
      font-weight: 600;
    }
    .results-table td {
      background-color: #fff;
      color: #333;
    }
    .score {
      font-weight: bold;
      font-size: 16px;
    }
    .criteria-explanation {
      color: #444;
      font-size: 14px;
      line-height: 1.5;
      margin-top: 6px;
    }
    .actions {
      text-align: center;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ecf0f1;
    }
    .btn {
      background-color: #34495e;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin: 10px 5px;
      transition: background-color 0.2s;
    }
    .btn:hover { background-color: #2c3e50; }
    .btn-secondary { background-color: #7f8c8d; }
    .btn-secondary:hover { background-color: #5f6c6d; }
    .error {
      background-color: #e74c3c;
      color: white;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
      margin: 20px 0;
    }
    .essay-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Результаты проверки эссе</h1>
    <div id="resultsContent">
      <div class="error">Загрузка результатов...</div>
    </div>

    <div class="actions">
      <a href="/" class="btn">Назад</a>
      <button id="downloadBtn" class="btn btn-secondary">Скачать JSON</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadResults);
    document.getElementById('downloadBtn').addEventListener('click', downloadResults);

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function loadResults() {
      fetch('/static/temp_results.json?' + new Date().getTime())
        .then(r => {
          if (!r.ok) throw new Error('Файл результатов не найден');
          return r.json();
        })
        .then(data => {
          const results = Array.isArray(data) ? data : (data.results || []);
          if (!results.length) {
            document.getElementById('resultsContent').innerHTML = 
              `<div class="error">Результаты отсутствуют</div>`;
            return;
          }
          renderResults(results);
        })
        .catch(err => {
          document.getElementById('resultsContent').innerHTML = 
            `<div class="error">Ошибка загрузки: ${escapeHtml(err.message)}</div>`;
        });
    }

    function renderResults(results) {
      const content = document.getElementById('resultsContent');
      let html = '';

      results.forEach((r, i) => {
        const essayText = r.essay_text || r.reference_text || '';
        const essayBlock = essayText
          ? `<div><strong>Текст эссе:</strong></div>
             <div style="margin:8px 0 15px 0; color:#333;">${escapeHtml(essayText)}</div>`
          : '';
        
        const maxTotal = 7; // 1 + 3 + 2 + 1

        html += `
          <div class="essay-block">
            <div class="essay-title">Эссе №${escapeHtml(r.essay_id || i+1)}</div>
            ${r.essay_type ? `<div><strong>Тип:</strong> ${escapeHtml(r.essay_type)}</div>` : ''}
            ${r.task_text ? `<div style="margin-top:10px;"><strong>Задание:</strong></div>
                             <div style="margin:8px 0 15px 0; color:#555;">${escapeHtml(r.task_text)}</div>` : ''}
            ${essayBlock}
            <h2>Результаты проверки</h2>
            <table class="results-table">
              <tr><th>K1</th><td><div class="score">${escapeHtml(r.H1 || 0)}/1</div><div class="criteria-explanation">${escapeHtml(r.H1_explanation || '')}</div></td></tr>
              <tr><th>K2</th><td><div class="score">${escapeHtml(r.H2 || 0)}/3</div><div class="criteria-explanation">${escapeHtml(r.H2_explanation || '')}</div></td></tr>
              <tr><th>K3</th><td><div class="score">${escapeHtml(r.H3 || 0)}/2</div><div class="criteria-explanation">${escapeHtml(r.H3_explanation || '')}</div></td></tr>
              <tr><th>K4</th><td><div class="score">${escapeHtml(r.H4 || 0)}/1</div><div class="criteria-explanation">${escapeHtml(r.H4_explanation || '')}</div></td></tr>
              <tr><th>Итого</th><td class="score">${escapeHtml(r.H1 + r.H2 + r.H3 + r.H4 || 0)}/${maxTotal}</td></tr>
            </table>
          </div>
        `;
      });

      content.innerHTML = html;
    }

    function downloadResults() {
      fetch('/static/temp_results.json')
        .then(r => r.blob())
        .then(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'essay_results.json';
          a.click();
          URL.revokeObjectURL(url);
        })
        .catch(err => alert('Ошибка при скачивании: ' + err.message));
    }
  </script>
</body>
</html>
